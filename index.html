<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema Intuitivo de Pr√©stamo de Herramientas</title>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
/* ============================================================
   ========================= ROOT =============================
   ============================================================ */

:root {
  --bg: #0a0f1c;
  --card: #0e1523;
  --muted: #8b9aab;
  --accent: #60a5fa;
  --accent-dark: #3b82f6;
  --accent-glow: rgba(96, 165, 250, 0.6);
  --danger: #f87171;
  --success: #34d399;
  --glass: rgba(255, 255, 255, 0.08);
  --glass-2: rgba(255, 255, 255, 0.04);
  --shadow-soft: rgba(0, 0, 0, 0.3);
  --shadow-strong: rgba(0, 0, 0, 0.6);
  --blur: blur(20px);
  --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-smooth: 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --transition-bounce: 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

/* ============================================================
   ========================= RESET =============================
   ============================================================ */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  transition: var(--transition-fast);
}

html, body {
  height: 100%;
  scroll-behavior: smooth;
}

/* ============================================================
   ======================== BACKGROUND =========================
   ============================================================ */

body {
  font-family: 'Inter', ui-sans-serif, system-ui, 'Segoe UI', Roboto, sans-serif;
  background: 
    radial-gradient(circle at 20% 20%, #1e293b, #0a0f1c 70%),
    linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  color: #f1f5f9;
  padding: 32px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  animation: bodyFadeIn 0.8s ease-out;
  letter-spacing: 0.3px;
  line-height: 1.6;
}

/* ============================================================
   ========================== LAYOUT ===========================
   ============================================================ */

.wrap {
  max-width: 1200px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr 380px;
  gap: 24px;
  align-items: start;
  animation: layoutRise 0.7s ease-out forwards;
}

/* ============================================================
   ========================== HEADER ===========================
   ============================================================ */

header {
  grid-column: 1 / -1;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding: 20px 0;
  border-bottom: 1px solid var(--glass);
}

h1 {
  font-size: 28px;
  font-weight: 900;
  background: linear-gradient(90deg, #60a5fa, #3b82f6, #1d4ed8);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  letter-spacing: -0.8px;
  animation: titleGlow 3s infinite ease-in-out;
  filter: drop-shadow(0 0 8px var(--accent-glow));
  text-shadow: 0 0 20px var(--accent-glow);
}

p.lead {
  color: var(--muted);
  font-size: 15px;
  margin-top: 6px;
  opacity: 0.9;
}

/* ============================================================
   =========================== CARDS ===========================
   ============================================================ */

.card {
  background: var(--glass-2);
  backdrop-filter: var(--blur);
  border-radius: 20px;
  padding: 24px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 
    0 10px 30px var(--shadow-soft),
    0 0 2px rgba(255, 255, 255, 0.1) inset,
    0 0 40px rgba(96, 165, 250, 0.05);
  animation: cardSlideIn 0.5s ease-out;
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--accent), var(--accent-dark));
  opacity: 0;
  transition: opacity 0.3s ease;
}

.card:hover {
  transform: translateY(-6px) scale(1.02);
  box-shadow: 
    0 15px 40px var(--shadow-strong),
    0 0 4px rgba(255, 255, 255, 0.15) inset,
    0 0 60px rgba(96, 165, 250, 0.1);
  filter: brightness(1.05);
}

.card:hover::before {
  opacity: 1;
}

/* ============================================================
   =========================== FORMS ===========================
   ============================================================ */

form .row {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}

label {
  font-size: 13px;
  font-weight: 700;
  color: var(--muted);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

input, select, textarea {
  width: 100%;
  padding: 14px 16px;
  border-radius: 14px;
  border: 1px solid rgba(255, 255, 255, 0.12);
  background: var(--glass);
  color: #f1f5f9;
  font-size: 15px;
  transition: var(--transition-smooth);
}

input:focus, select:focus, textarea:focus {
  transform: scale(1.02);
  border: 1px solid var(--accent);
  box-shadow: 
    0 0 0 4px rgba(96, 165, 250, 0.2),
    0 0 20px rgba(96, 165, 250, 0.1);
  outline: none;
  background: rgba(255, 255, 255, 0.06);
}

/* ============================================================
   ========================== BUTTONS ==========================
   ============================================================ */

button {
  padding: 14px 18px;
  border-radius: 14px;
  border: 0;
  font-weight: 800;
  cursor: pointer;
  font-size: 15px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 50%, #1e40af 100%);
  color: #0f172a;
  box-shadow: 
    0 6px 20px rgba(96, 165, 250, 0.3),
    0 0 2px rgba(255, 255, 255, 0.2) inset;
  transition: var(--transition-bounce);
  position: relative;
  overflow: hidden;
}

button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s ease;
}

button:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 
    0 8px 30px rgba(96, 165, 250, 0.4),
    0 0 4px rgba(255, 255, 255, 0.3) inset;
  filter: brightness(1.1);
}

button:hover::before {
  left: 100%;
}

button:active {
  transform: scale(0.98);
}

button.ghost {
  background: var(--glass);
  border: 1px solid rgba(255, 255, 255, 0.15);
  color: var(--muted);
  box-shadow: 0 4px 15px var(--shadow-soft);
}

button.ghost:hover {
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  color: #f1f5f9;
}

/* ============================================================
   =========================== LISTS ===========================
   ============================================================ */

.list {
  margin-top: 16px;
  max-height: 75vh;
  overflow: auto;
  padding-right: 8px;
  animation: listFadeIn 0.6s ease-out;
}

/* Scrollbar */
.list::-webkit-scrollbar {
  width: 10px;
}

.list::-webkit-scrollbar-track {
  background: var(--glass-2);
  border-radius: 5px;
}

.list::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 5px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.list::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* ============================================================
   =========================== ITEMS ===========================
   ============================================================ */

.item {
  display: flex;
  gap: 16px;
  align-items: flex-start;
  padding: 18px;
  border-radius: 16px;
  border: 1px solid rgba(255, 255, 255, 0.08);
  background: var(--glass);
  backdrop-filter: blur(15px);
  margin-bottom: 12px;
  animation: itemSlideIn 0.4s ease-out;
  position: relative;
  transition: var(--transition-smooth);
}

.item:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateX(4px) scale(1.01);
  box-shadow: 0 8px 25px var(--shadow-soft);
  filter: brightness(1.05);
}

.item .main {
  flex: 1;
}

.meta {
  font-size: 14px;
  color: var(--muted);
  margin-top: 8px;
  opacity: 0.8;
}

/* Badges */
.badge {
  font-size: 12px;
  padding: 8px 12px;
  border-radius: 20px;
  background: var(--glass);
  border: 1px solid rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(10px);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.overdue .badge {
  background: rgba(185, 28, 28, 0.3);
  border-color: #dc2626;
  color: #fecaca;
  box-shadow: 0 0 10px rgba(220, 38, 38, 0.3);
}

/* Pending count */
.pending-count {
  font-size: 15px;
  color: var(--danger);
  font-weight: 800;
  margin-left: 10px;
  animation: pulse 2s infinite;
}

/* Controls */
.controls {
  display: flex;
  gap: 10px;
  align-items: center;
}

.small {
  padding: 8px 12px;
  font-size: 13px;
  border-radius: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.returned {
  opacity: 0.6;
  text-decoration: line-through;
  filter: grayscale(0.8) blur(0.5px);
  transition: opacity 0.3s ease;
}

/* Strike label */
.strike-visual {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 8px;
  background: rgba(0, 0, 0, 0.4);
  color: var(--muted);
  font-size: 12px;
  font-weight: 600;
}

/* ============================================================
   =========================== FOOTER ==========================
   ============================================================ */

footer {
  grid-column: 1 / -1;
  margin-top: 20px;
  color: var(--muted);
  font-size: 14px;
  text-align: center;
  opacity: 0.8;
}

/* ============================================================
   =============== ANIMACIONES EXTREMADAMENTE FLUIDAS =========
   ============================================================ */

@keyframes bodyFadeIn {
  0% {
    opacity: 0;
    transform: translateY(20px) scale(0.98);
    filter: blur(8px);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
    filter: blur(0);
  }
}

@keyframes layoutRise {
  0% {
    opacity: 0;
    transform: translateY(40px) scale(0.95);
  }
  60% {
    opacity: 1;
    transform: translateY(-8px) scale(1.02);
  }
  100% {
    transform: translateY(0) scale(1);
  }
}

@keyframes cardSlideIn {
  0% {
    opacity: 0;
    transform: translateY(30px) scale(0.95);
    filter: blur(6px);
  }
  50% {
    opacity: 0.8;
    transform: translateY(-5px) scale(1.01);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
    filter: blur(0);
  }
}

@keyframes listFadeIn {
  0% {
    opacity: 0;
    transform: translateY(15px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes itemSlideIn {
  0% {
    opacity: 0;
    transform: translateX(-15px) scale(0.96) rotateZ(-0.5deg);
    filter: blur(4px);
  }
  70% {
    opacity: 1;
    transform: translateX(3px) scale(1.01) rotateZ(0deg);
  }
  100% {
    transform: translateX(0) scale(1);
    filter: blur(0);
  }
}

@keyframes titleGlow {
  0%, 100% {
    text-shadow: 
      0 0 10px var(--accent-glow),
      0 0 20px var(--accent-glow),
      0 0 30px var(--accent-glow);
    filter: brightness(1);
  }
  50% {
    text-shadow: 
      0 0 20px var(--accent-glow),
      0 0 40px var(--accent-glow),
      0 0 60px var(--accent-glow);
    filter: brightness(1.2);
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

/* ============================================================
   =============== MICRO-TRANSICIONES PROFESIONALES ===========
   ============================================================ */

.card, .item, button, input, select, textarea {
  transition: 
    background var(--transition-smooth),
    border var(--transition-fast),
    box-shadow var(--transition-smooth),
    transform var(--transition-bounce),
    filter var(--transition-smooth);
  will-change: transform, opacity, filter;
}

/* Hover superior */
.card:hover {
  transform: translateY(-8px) scale(1.02);
  filter: brightness(1.08);
}

.item:hover {
  transform: translateX(6px) scale(1.01);
  filter: brightness(1.08);
}

/* Botones con presi√≥n realista */
button:active {
  transform: scale(0.96);
}

/* Inputs con retroiluminaci√≥n m√°s suave */
input:focus, select:focus, textarea:focus {
  box-shadow: 
    0 0 0 5px rgba(96, 165, 250, 0.25),
    0 0 30px rgba(96, 165, 250, 0.1);
}

/* ============================================================
   ======================= RESPONSIVE PRO+ =====================
   ============================================================ */

@media (max-width: 768px) {
  body {
    padding: 20px;
    letter-spacing: 0.2px;
  }

  .wrap {
    grid-template-columns: 1fr;
    gap: 20px;
    animation: layoutRise 0.8s ease-out;
  }

  header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  h1 {
    font-size: 24px;
    animation: titleGlow 4s infinite ease-in-out;
  }

  .card {
    padding: 18px;
    border-radius: 18px;
    animation: cardSlideIn 0.6s ease-out;
  }

  form .row {
    flex-direction: column;
    gap: 10px;
  }

  input, select, textarea {
    font-size: 16px; /* Prevents zoom on iOS */
    padding: 14px;
    border-radius: 12px;
  }

  button {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    font-size: 15px;
  }

  .list {
    max-height: calc(100vh - 260px);
    padding-right: 6px;
    animation: listFadeIn 0.7s ease-out;
  }

  .item {
    padding: 16px;
    border-radius: 14px;
    gap: 14px;
    animation: itemSlideIn 0.5s ease-out;
  }

  .item .main h3 {
    font-size: 17px !important;
  }

  .meta {
    font-size: 14px;
  }

  .badge {
    font-size: 11px;
    padding: 6px 10px;
  }

  footer {
    padding-top: 16px;
    font-size: 14px;
  }
}

/* ============================================================
   ========================= CLOSE PANEL =======================
   ============================================================ */

#closePanel {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--glass);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: var(--muted) !important;
  font-size: 22px !important;
  font-weight: 700;
  line-height: 0;
  backdrop-filter: var(--blur);
  cursor: pointer;
  transition: var(--transition-smooth);
  box-shadow: 0 4px 15px var(--shadow-soft);
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 10;
}

#closePanel:hover {
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.2);
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 6px 20px var(--shadow-strong);
  color: #f1f5f9 !important;
}

#closePanel:active {
  transform: scale(0.95) rotate(90deg);
}

@media (max-width: 768px) {
  #closePanel {
    width: 44px;
    height: 44px;
    font-size: 26px !important;
    right: 16px !important;
    top: 16px !important;
  }
}



</style>


</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Sistema de Pr√©stamo de Herramientas</h1>
        <p class="lead">Registra, marca y tacha como si fuera papel. Todo sincronizado.</p>
      </div>
      <div style="text-align:right">
        <div class="badge">Inventario global ‚Ä¢ Firestore</div>
      </div>
    </header>

    <!-- FORM -->
    <section class="card">
      <h2 style="margin:0 0 8px 0;font-size:16px">Registrar pr√©stamo</h2>

      <form id="loanForm" autocomplete="off">

        <div class="row">
          <div style="flex:1">
            <label>Nombre del usuario</label>
            <input id="person" type="text" required />
          </div>

          <div style="width:180px; position:relative">
            <label>Herramienta</label>
            <input id="tool" type="text" required />
          </div>
        </div>

        <div class="row">
          <div style="width:120px">
            <label>Cant.</label>
            <input id="quantity" type="number" min="1" value="1" required />
          </div>

          <div style="flex:1">
            <label>Fecha de entrega</label>
            <input id="dueDate" type="date" required />
          </div>

          <div style="width:140px">
            <label>Prioridad</label>
            <select id="priority">
              <option value="normal">Normal</option>
              <option value="alta">Alta</option>
              <option value="baja">Baja</option>
            </select>
          </div>
        </div>

        <div class="row" style="align-items:center">
          <button type="submit">A√±adir pr√©stamo</button>
          <button type="button" id="clearAll" class="ghost">Borrar todo</button>
          <div style="flex:1"></div>
        </div>

      </form>

      <hr style="border:none;height:12px">

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Pr√©stamos activos</strong>
        <div>
          <button id="showAll" class="ghost small">Mostrar todos</button>
          <button id="showOverdue" class="ghost small">Solo atrasados</button>
          
        </div>
      </div>

      <div id="activeList" class="list" aria-live="polite"></div>
    </section>

    <!-- ASIDE -->
    <aside class="card">
      <h2 style="margin:0 0 8px 0;font-size:16px">Panel</h2>

      <div style="margin-bottom:10px">
        <label>Buscar</label>
        <input id="search" type="text" placeholder="Buscar por nombre o herramienta" />
      </div>

      <div style="display:flex;gap:8px;margin-bottom:10px">
        <div style="flex:1">
          <label>Pendientes guardados</label>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Pendientes / Guardados</strong>
        <div id="pendingCount" class="pending-count">0</div>
      </div>

      <div id="pendingList" class="list"></div>
    </aside>

    <footer class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
        <span>En tiempo real!.</span>
        <div style="display: flex; gap: 10px;">
        <button id="downloadPendingPDF" class="small ghost">üìÑ PDF Pendientes</button>
        <button id="downloadActiveTodayPDF" class="small ghost">üìÑ PDF Activos Hoy</button>
        </div>
    </div>
    </footer>
  </div>

<!-- üî• AUTOCOMPLETADO & FIREBASE -->


<script type="module">

/* ============================================================
   ===============  CARGAR tools.json  =========================
   ============================================================ */
let toolList = [];

async function loadTools() {
  try {
    const res = await fetch("tools.json");
    toolList = await res.json();
    setupToolAutocomplete();
  } catch (err) { console.error("Error cargando tools.json", err); }
}
loadTools();

/* ============ AUTOCOMPLETADO ============ */
function setupToolAutocomplete() {
  const input = document.getElementById("tool");

  const box = document.createElement("div");
  box.id = "tool-autocomplete";
  box.style.position = "absolute";
  box.style.background = "var(--card)";
  box.style.border = "1px solid rgba(255,255,255,0.1)";
  box.style.borderRadius = "8px";
  box.style.padding = "6px";
  box.style.maxHeight = "160px";
  box.style.overflowY = "auto";
  box.style.display = "none";
  box.style.zIndex = "9999";
  document.body.appendChild(box);

  input.addEventListener("input", () => {
    const q = input.value.toLowerCase();
    if (!q) { box.style.display="none"; return; }

    const filtered = toolList.filter(t => t.toLowerCase().includes(q));
    if (!filtered.length) { box.style.display="none"; return; }

    const rect = input.getBoundingClientRect();
    box.style.left = rect.left + window.scrollX + "px";
    box.style.top = rect.bottom + window.scrollY + "px";
    box.style.width = rect.width + "px";

    box.innerHTML = filtered.map(t=>`<div style="padding:6px;cursor:pointer">${t}</div>`).join("");

    box.querySelectorAll("div").forEach(div=>{
      div.onclick = () => {
        input.value = div.textContent;
        box.style.display="none";
      };
    });

    box.style.display="block";
  });

  document.addEventListener("click", e=>{
    if (e.target !== input && !e.target.closest("#tool-autocomplete"))
      box.style.display="none";
  });
}

/* ============================================================
   ==================  FIREBASE  ===============================
   ============================================================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, deleteDoc,
  doc, updateDoc, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCsPATOHurWixNzoSGWmRXNK_qxQJVcK6g",
    authDomain: "herramienta-2802d.firebaseapp.com",
    projectId: "herramienta-2802d",
    storageBucket: "herramienta-2802d.firebasestorage.app",
    messagingSenderId: "985971934426",
    appId: "1:985971934426:web:cb245e82e1ebe7399551e3"
  };




const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* üß™üíÄ ADDED: pending */
const pendingRef = collection(db, "pending");
/* üß™üíÄ END */

const loansRef = collection(db, "loans");
const historyRef = collection(db, "history");

/* ============================================================
   ==================  UTILIDADES  =============================
   ============================================================ */

const $ = (id) => document.getElementById(id);

const todayISODate = () => {
  const d = new Date();
  const tzOffset = d.getTimezoneOffset() * 60000;
  return new Date(d - tzOffset).toISOString().slice(0,10);
};

const escapeHtml = s =>
  String(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* ============================================================
   =====================  ESTADO  ==============================
   ============================================================ */
let loans = [];
let pending = []; /* üß™üíÄ ADDED */
let currentPanelPerson = null;
let currentPanelType = null;

/* Listener: LOANS */
onSnapshot(loansRef, (snap) => {
  loans = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderAll();
  if (currentPanelPerson && currentPanelType === "active") {
    openDetails(currentPanelPerson, currentPanelType);
  }
});

/* Listener: PENDING */
onSnapshot(pendingRef, (snap) => {
  pending = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderPendingList();
  if (currentPanelPerson && currentPanelType === "pending") {
    openDetails(currentPanelPerson, currentPanelType);
  }
});
/* ============================================================
   =========================== CRUD ============================
   ============================================================ */

async function addLoan({person, tool, quantity, dueDate, priority}) {
  await addDoc(loansRef, {
    person, tool, quantity, dueDate, priority,
    returned: false,
    createdAt: new Date().toISOString()  // Cambia aqu√≠: fecha local inmediata
  });
}

async function removeLoan(id) {
  await deleteDoc(doc(db, "loans", id));
}

/* üß™üíÄ ADDED ‚Äî mover a pendientes */
/* ==================== MOVE TO PENDING ==================== */
async function moveToPending(id) {
  // Buscar el pr√©stamo
  const loanItem = loans.find(x => x.id === id);
  if (!loanItem) return;

  try {
    // 1Ô∏è‚É£ Agregar a pendientes en Firestore
    await addDoc(pendingRef, {
      person: loanItem.person,
      tool: loanItem.tool,
      quantity: loanItem.quantity,
      dueDate: loanItem.dueDate,
      priority: loanItem.priority,
      createdAt: loanItem.createdAt || new Date(),
      movedAt: serverTimestamp()
    });

    // 2Ô∏è‚É£ Eliminar de Firestore activo
    await deleteDoc(doc(db, "loans", id));

    // 3Ô∏è‚É£ Actualizar arrays locales
    loans = loans.filter(x => x.id !== id); // Quitar de loans
    pending.push({
      ...loanItem,
      movedAt: new Date() // Para mantener consistencia visual
    });

    // 4Ô∏è‚É£ Actualizar UI visualmente (remover tarjeta del panel)
    const detailsContent = $("detailsContent");
    const card = detailsContent.querySelector(`.loan-item[data-id="${id}"]`);
    if (card) {
      // Animaci√≥n de desvanecimiento
      card.style.transition = "opacity 0.4s, transform 0.4s";
      card.style.opacity = "0";
      card.style.transform = "translateX(50px) rotate(-5deg)";
      
      // Despu√©s de la animaci√≥n, remover el nodo del DOM
      setTimeout(() => card.remove(), 400);
    }

    // 5Ô∏è‚É£ Refrescar el panel de detalles si est√° abierto para esta persona en "active"
    if (currentPanelPerson === loanItem.person && currentPanelType === "active") {
      // Esperar un poco para que los listeners de Firestore se disparen y actualicen los arrays
      setTimeout(() => {
        openDetails(currentPanelPerson, "active");
      }, 100); // Peque√±o delay para sincronizaci√≥n
    }

  } catch (err) {
    console.error("Error moviendo a pendientes:", err);
  }
}


async function removeQuantity(id, collectionName, amountToRemove) {
  const isPending = collectionName === "pending";
  const list = isPending ? pending : loans;
  const docRef = doc(db, collectionName, id);

  const item = list.find(x => x.id === id);
  if (!item) return;

  if (amountToRemove >= item.quantity) {
    // BORRAR COMPLETAMENTE
    await deleteDoc(docRef);

    // ELIMINAR DEL ARRAY LOCAL
    const idx = list.findIndex(x => x.id === id);
    if (idx !== -1) list.splice(idx, 1);

    // ACTUALIZAR PANEL DETALLES SI EST√Å ABIERTO
    removeItemFromDetails(id);
  } else {
    // RESTAR
    item.quantity -= amountToRemove;

    // ACTUALIZAR FIRESTORE
    await updateDoc(docRef, { quantity: item.quantity });

    // ACTUALIZAR PANEL DETALLES SI EST√Å ABIERTO
    updateItemQuantityInDetails(id, item.quantity);
  }

  // REFRESCAR PANEL COMPLETO (opcional para garantizar coherencia)
  if ($("sidePanel").style.right === "0") {
    openDetails(item.person, isPending ? "pending" : "active");
  }
}











/* üß™üíÄ END */

async function toggleReturned(id) {
  const l = loans.find(x => x.id === id);
  if (!l) return;

  if (!l.returned) {
    await addDoc(historyRef, {
      person: l.person,
      tool: l.tool,
      quantity: l.quantity,
      dueDate: l.dueDate,
      priority: l.priority,
      createdAt: l.createdAt || null,
      returnedAt: new Date().toISOString()
    });

    await deleteDoc(doc(db, "loans", id));
    return;
  }

  await updateDoc(doc(db, "loans", id), { returned: false });
}

/* ============================================================
   =============  VOLVER DE PENDIENTES A ACTIVOS  =============
   ============================================================ */

/* ==================== RETURN FROM PENDING ==================== */
async function returnFromPending(id) {
  const item = pending.find(x => x.id === id);
  if (!item) return;

  // Agregar a loans
  await addDoc(loansRef, {
    person: item.person,
    tool: item.tool,
    quantity: item.quantity,
    dueDate: item.dueDate,
    priority: item.priority,
    createdAt: item.createdAt
      ? (typeof item.createdAt.toDate === "function" ? item.createdAt.toDate() : new Date(item.createdAt))
      : new Date(),
    returned: false
  });

  // Borrar del pending
  await deleteDoc(doc(db, "pending", id));
}

function removeItemFromDetails(id) {
  const details = $("detailsContent");
  const itemEl = details.querySelector(`[data-id="${id}"]`);
  if (!itemEl) return;

  // Animaci√≥n de desvanecimiento y desplazamiento
  itemEl.style.transition = "opacity 0.4s, transform 0.4s";
  itemEl.style.opacity = "0";
  itemEl.style.transform = "translateX(50px) rotate(-5deg)";

  // Eliminar del DOM despu√©s de la animaci√≥n
  setTimeout(() => {
    itemEl.remove();

    // Actualizar el contador de registros en el panel
    const counterEl = details.querySelector("div[style*='opacity:.75']"); // Cambi√© a .75 para coincidir con tu estilo de header
    if (counterEl) {
      const current = parseInt(counterEl.textContent.match(/\d+/)[0], 10);
      counterEl.textContent = `Total de registros: ${Math.max(0, current - 1)}`;
    }
  }, 400);
}

function updateItemQuantityInDetails(id, newQty) {
  const details = $("detailsContent");
  const itemEl = details.querySelector(`[data-id="${id}"]`);
  if (!itemEl) return;

  if (newQty <= 0) {
    // Elimina la tarjeta si la cantidad llega a 0
    itemEl.remove();
    return;
  }

  // Busca el div que contiene "Cantidad:" sin importar emojis ni espacios
  const qtyDiv = Array.from(itemEl.querySelectorAll("div"))
    .find(d => /Cantidad:/.test(d.textContent));

  if (qtyDiv) {
    // Reescribe solo el n√∫mero manteniendo el emoji
    const parts = qtyDiv.textContent.split("Cantidad:");
    qtyDiv.textContent = `${parts[0]}Cantidad: ${newQty}`;
  }
}







/* ============================================================
   ======================== RENDER ==============================
   ============================================================ */

function renderAll() {
  renderActiveList();
  renderPendingList();
}

function closeDetails() {
  currentPanelPerson = null;
  currentPanelType = null;
  $("sidePanel").style.right = "-500px";
}

function renderActiveList(query = "") {
  const container = $("activeList");
  container.innerHTML = "";

  let data = loans;

  if (query) {
    data = loans.filter(l =>
      l.person.toLowerCase().includes(query) ||
      l.tool.toLowerCase().includes(query)
    );
  }

  // Agrupar por persona
  const groups = {};
  for(const l of data){
    if(!groups[l.person]) groups[l.person] = [];
    groups[l.person].push(l);
  }

  // Orden por prioridad dentro de cada grupo
  const order = { alta:1, normal:2, baja:3 };

  for(const person in groups){
    const items = groups[person].sort((a,b)=>order[a.priority]-order[b.priority]);

    const block = document.createElement("div");
    block.className = "item";

    block.innerHTML = `
      <div class="main">
        <strong style="font-size:16px">${person}</strong>
        <div class="meta">${items.length} registros</div>
      </div>

      <div class="controls">
        <button class="small ghost" data-action="details-person" data-person="${person}">
          Detalles
        </button>
      </div>
    `;

    container.appendChild(block);
  }
}



/* üß™üíÄ NEW REAL pending list ‚Äî basado en colecci√≥n pending */
/* ============================================================
   ============  PENDIENTES (COLORES POR D√çAS)  ===============
   ============================================================ */



   
/* ======================= RENDER PENDING LIST ======================= */
/* ======================= RENDER PENDING LIST ======================= */
/* ======================= RENDER PENDING LIST ======================= */
function renderPendingList() {
  const container = $("pendingList");
  container.innerHTML = "";

  $("pendingCount").textContent = pending.length;

  if (!pending.length) {
    container.innerHTML = `<div style="color:var(--muted);padding:12px">
      No hay pendientes guardados.
    </div>`;
    return;
  }

  const groups = {};
  pending.forEach(l => {
    if (!groups[l.person]) groups[l.person] = [];
    groups[l.person].push(l);
  });

  const order = { alta: 1, normal: 2, baja: 3 };

  const colorByDays = (days) => {
    if (days < 10) return "#4ade80";
    if (days < 20) return "#facc15";
    return "#f87171";
  };

  // Usa la funci√≥n global diffDays (definida abajo)
  for (const person in groups) {
    const items = groups[person].sort((a,b) => order[a.priority] - order[b.priority]);
    const total = items.length;

    // Tomamos la fecha m√°s reciente correctamente
    const latest = items.slice().sort((a,b)=>{
      const dateA = a.movedAt ? (typeof a.movedAt.toDate === "function" ? a.movedAt.toDate() : new Date(a.movedAt)) 
                               : (a.createdAt ? (typeof a.createdAt.toDate === "function" ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date());
      const dateB = b.movedAt ? (typeof b.movedAt.toDate === "function" ? b.movedAt.toDate() : new Date(b.movedAt)) 
                               : (b.createdAt ? (typeof b.createdAt.toDate === "function" ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date());
      return dateB - dateA; // descendente, m√°s reciente primero
    })[0];

    const baseDate = new Date(latest.dueDate);  // Asume que dueDate es una cadena ISO (YYYY-MM-DD)
    const days = diffDays(baseDate);

    const color = colorByDays(days);

    const block = document.createElement("div");
    block.className = "item";
    block.style.borderLeft = `6px solid ${color}`;

    block.innerHTML = `
      <div class="main">
        <strong style="font-size:16px">${person}</strong>
        <div class="meta">${total} registros ‚Ä¢ ${days} d√≠as fuera</div>
      </div>
      <div class="controls">
        <button class="small ghost" data-action="details-person" data-person="${person}" data-type="pending">
          Detalles
        </button>
      </div>
    `;

    container.appendChild(block);
  }
}

// Funci√≥n global para calcular d√≠as de retraso
// Conversi√≥n robusta de fecha (acepta: Firestore Timestamp, string, ISO, Date)
// ===============================
//   Conversi√≥n universal de fechas
// ===============================
function toValidDate(input) {
  if (!input) return null;

  // Firestore Timestamp
  if (typeof input === "object" && input.seconds != null) {
    return new Date(input.seconds * 1000);
  }

  // Firestore Timestamp .toDate()
  if (typeof input === "object" && typeof input.toDate === "function") {
    return input.toDate();
  }

  // Format dd/mm/yyyy
  if (typeof input === "string" && input.includes("/") && input.split("/").length === 3) {
    const [d, m, y] = input.split("/");
    return new Date(`${y}-${m}-${d}`);
  }

  // ISO, Date compatible
  const d = new Date(input);
  return isNaN(d.getTime()) ? null : d;
}


// ===============================
//   Diferencia de d√≠as segura
// ===============================
function diffDays(date) {
  const d = toValidDate(date);
  if (!d) return "N/A";

  const now = new Date();
  return Math.floor((now - d) / (1000 * 60 * 60 * 24));
}


// ===============================
//   Normalizaci√≥n total p/ PDF
// ===============================
function safe(v) {
  if (v === null || v === undefined) return "N/A";

  // Firestore Timestamp
  if (typeof v === "object" && typeof v.toDate === "function") {
    return v.toDate().toISOString().split("T")[0];  // YYYY-MM-DD limpio
  }

  // Firestore Timestamp crudo {seconds, nanoseconds}
  if (typeof v === "object" && v.seconds != null) {
    return new Date(v.seconds * 1000).toISOString().split("T")[0];
  }

  // Date nativa
  if (v instanceof Date) {
    return v.toISOString().split("T")[0];
  }

  // Primitivos
  return v.toString();
}

/* ==========================================================
   GENERAR PDF DE PENDIENTES
   ========================================================== */
function generatePendingPDF() {
  console.log("Generando PDF de pendientes...");

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");
    const now = new Date();

    /* ===============================
       ENCABEZADO PROFESIONAL
       =============================== */
    doc.setFillColor(96, 165, 250);
    doc.rect(0, 0, 210, 20, "F");

    doc.setFontSize(16);
    doc.setTextColor(255, 255, 255);
    doc.text("Reporte de Pendientes", 10, 13);

    doc.setFontSize(10);
    doc.text(`Generado: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, 200, 13, { align: "right" });

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(12);
    let currentY = 30;
    doc.text("Herramientas con d√≠as de retraso", 10, currentY);
    currentY += 6;

    /* ===============================
       AGRUPAR POR PERSONA
       =============================== */
    const grouped = {};
    pending.forEach(item => {
      if (!grouped[item.person]) grouped[item.person] = [];
      grouped[item.person].push(item);
    });

    const blockColors = [
      [230, 245, 255], // azul muy suave
      [245, 245, 245], // gris suave
      [255, 240, 230], // naranja muy suave
      [240, 255, 240]  // verde muy suave
    ];

    let colorIndex = 0;

    for (const person in grouped) {
      const items = grouped[person];

      // Fondo para el bloque de persona
      doc.setFillColor(...blockColors[colorIndex % blockColors.length]);
      doc.rect(10, currentY - 4, 190, 6 + items.length * 8, "F");

      // Sub-encabezado de persona
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`Persona: ${person}`, 12, currentY);
      currentY += 6;

      // Datos de la tabla
      const tableData = items.map(item => {
        const due = toValidDate(item.dueDate);
        return [
          safe(item.person),
          safe(item.tool),
          safe(item.quantity),
          due ? diffDays(due).toString() : "N/A",
          due ? due.toLocaleDateString() : "N/A",
        ];
      });

      // Crear tabla
      doc.autoTable({
        startY: currentY,
        head: [["Persona", "Herramienta", "Cantidad", "D√≠as Afuera", "Fecha Entrega"]],
        body: tableData,
        theme: "grid",
        headStyles: {
          fillColor: [96, 165, 250],
          textColor: 255,
          fontSize: 10,
          halign: "center",
        },
        styles: { fontSize: 10, cellPadding: 3 },
        bodyStyles: { halign: "center" },
        alternateRowStyles: { fillColor: [255, 255, 255] },
        didDrawPage: (data) => {
          currentY = data.cursor.y + 8;
        },
      });

      currentY += 4;
      colorIndex++;

      // Salto de p√°gina si es necesario
      if (currentY > 270) {
        doc.addPage();
        currentY = 20;
      }
    }

    /* ===============================
       PIE DE P√ÅGINA
       =============================== */
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(9);
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.text(`P√°gina ${i} de ${pageCount}`, 105, 290, { align: "center" });
    }

    /* ===============================
       GUARDAR
       =============================== */
    doc.save("pendientes_reporte.pdf");
    console.log("PDF de pendientes descargado.");

  } catch (error) {
    console.error("Error generando PDF de pendientes:", error);
    alert("Error: " + error.message);
  }
}


/* ==========================================================
   GENERAR PDF DE ACTIVOS HOY
   ========================================================== */
function generateActiveTodayPDF() {
  console.log("Generando PDF de activos hoy...");

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

    // Estilos de t√≠tulo
    doc.setFont("helvetica", "bold");
    doc.setFontSize(20);
    doc.setTextColor(33, 37, 41);
    doc.text("Reporte de Pr√©stamos Activos del D√≠a", doc.internal.pageSize.getWidth() / 2, 40, { align: "center" });

    // L√≠nea decorativa
    doc.setDrawColor(96, 165, 250);
    doc.setLineWidth(1.5);
    doc.line(40, 50, doc.internal.pageSize.getWidth() - 40, 50);

    const today = new Date().toISOString().split("T")[0];

    const todaysLoans = loans.filter(item => {
      const d = toValidDate(item.createdAt);
      if (!d) return false;
      return d.toISOString().split("T")[0] === today;
    });

    const tableData = todaysLoans.map(item => {
      const due = toValidDate(item.dueDate);

      return [
        safe(item.person),
        safe(item.tool),
        safe(item.quantity),
        due ? due.toLocaleDateString() : "N/A",
        safe(item.priority)
      ];
    });

    if (todaysLoans.length === 0) {
      doc.setFontSize(14);
      doc.setTextColor(150, 150, 150);
      doc.text("No hay pr√©stamos activos registrados hoy.", doc.internal.pageSize.getWidth() / 2, 120, { align: "center" });
    } else {
      doc.autoTable({
        startY: 70,
        head: [["Persona", "Herramienta", "Cantidad", "Fecha Entrega", "Prioridad"]],
        body: tableData,
        theme: "grid",
        headStyles: {
          fillColor: [96, 165, 250],
          textColor: 255,
          fontStyle: "bold",
          halign: "center"
        },
        bodyStyles: {
          fontSize: 11,
          textColor: 50
        },
        alternateRowStyles: {
          fillColor: [245, 245, 245]
        },
        columnStyles: {
          0: { cellWidth: 100 },
          1: { cellWidth: 150 },
          2: { cellWidth: 60, halign: "center" },
          3: { cellWidth: 80, halign: "center" },
          4: { cellWidth: 60, halign: "center" }
        },
        styles: { cellPadding: 6 }
      });
    }

    // Pie de p√°gina
    const pageHeight = doc.internal.pageSize.getHeight();
    doc.setFontSize(9);
    doc.setTextColor(130);
    doc.text(`Generado el ${new Date().toLocaleString()}`, doc.internal.pageSize.getWidth() - 40, pageHeight - 20, { align: "right" });

    doc.save("activos_hoy_reporte.pdf");
    console.log("PDF de activos hoy descargado.");
  } catch (error) {
    console.error("Error generando PDF de activos hoy:", error);
    alert("Error: " + error.message);
  }
}

/* üß™üíÄ END */





/* ============================================================
   ============   PANEL LATERAL DE DETALLES   ==================
   ============================================================ */

/* ======================= OPEN DETAILS ======================= */
function openDetails(personName, type = "active") {
  const panel = $("sidePanel");
  const details = $("detailsContent");
    
  const listToShow = type === "pending" ? pending : loans;
  const items = listToShow.filter(x => x.person === personName && x.quantity > 0);

  currentPanelPerson = personName;
  currentPanelType = type;
  const diffDays = (date) => {
    const now = new Date();
    return Math.floor((now - date) / (1000 * 60 * 60 * 24));
  };

  const colorByDays = (days) => {
    if (days < 10) return "#10b981"; // verde esmeralda
    if (days < 20) return "#f59e0b"; // √°mbar intenso
    return "#dc2626"; // rojo carmes√≠
  };

  const formatDateTime = (dateInput) => {
    if (!dateInput) return "‚Äî";
    const d = typeof dateInput.toDate === "function" ? dateInput.toDate() : new Date(dateInput);
    return d.toLocaleString("es-ES", { dateStyle: "medium", timeStyle: "short" });
  };

  // Funci√≥n para animar entrada de elementos
  const animateIn = (element, delay = 0) => {
    setTimeout(() => {
      element.style.opacity = '0';
      element.style.transform = 'translateY(20px)';
      element.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
      requestAnimationFrame(() => {
        element.style.opacity = '1';
        element.style.transform = 'translateY(0)';
      });
    }, delay);
  };

  // Cabecera principal con animaci√≥n de entrada
  let html = `
    <div id="header" style="
      margin-bottom: 32px;
      font-size: 32px;
      font-weight: 900;
      color: #06b6d4;
      letter-spacing: 1.5px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.8s ease-out, transform 0.8s ease-out;
    ">
      ${personName}
    </div>
    <div id="total" style="
      opacity: 0.8;
      margin-bottom: 40px;
      font-size: 18px;
      font-weight: 600;
      color: #e2e8f0;
      background: linear-gradient(135deg, #1e293b, #334155);
      padding: 12px 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      transform: translateY(-10px);
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    ">
      üìä Total de registros: ${items.length}
    </div>
  `;

  // Generar items con animaciones escalonadas
  items.forEach((i, index) => {
    const isPending = type === "pending";
    const days = isPending && i.dueDate ? diffDays(new Date(i.dueDate)) : 0;
    const borderColor = isPending ? colorByDays(days) : "#0ea5e9";

    const createdAtStr = formatDateTime(i.createdAt);
    const dueDateStr = i.dueDate || "‚Äî";

    html += `
      <div class="loan-item" data-id="${i.id}" style="
        display: flex;
        flex-direction: column;
        background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(30,41,59,0.98));
        border-left: 8px solid ${borderColor};
        border-radius: 24px;
        padding: 28px;
        margin-bottom: 28px;
        box-shadow: 0 16px 32px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        opacity: 0;
        transform: translateY(30px) scale(0.95);
        cursor: pointer;
      "
      onmouseover="
        this.style.transform = 'translateY(-8px) scale(1.03)';
        this.style.boxShadow = '0 24px 48px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255,255,255,0.2)';
        this.style.borderLeftWidth = '12px';
      " 
      onmouseout="
        this.style.transform = 'translateY(0) scale(1)';
        this.style.boxShadow = '0 16px 32px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1)';
        this.style.borderLeftWidth = '8px';
      ">

        <!-- Informaci√≥n principal con mejor dise√±o -->
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
          <div style="flex: 1; min-width: 0;">
            <div style="
              font-size: 24px;
              font-weight: 800;
              color: #38bdf8;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
              margin-bottom: 8px;
              text-shadow: 0 1px 2px rgba(0,0,0,0.7);
            ">
              ${i.tool || "‚Äî"}
            </div>
            <span style="
              background: ${i.priority === "alta" ? "linear-gradient(135deg, #ef4444, #dc2626)" : i.priority === "media" ? "linear-gradient(135deg, #f59e0b, #d97706)" : "linear-gradient(135deg, #10b981, #059669)"};
              color: white;
              font-weight: 700;
              font-size: 12px;
              padding: 6px 14px;
              border-radius: 16px;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            ">
              ${i.priority || "normal"}
            </span>
          </div>
        </div>

        <!-- Datos secundarios en grid mejorado -->
        <div style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
          gap: 16px;
          font-size: 15px;
          opacity: 0.95;
          margin-bottom: 20px;
        ">
          <div style="
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            padding: 12px 16px;
            border-radius: 16px;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transition: transform 0.2s ease;
          " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <span style="color: #fbbf24; font-size: 20px;">üì¶</span> 
            Cantidad: ${i.quantity}
          </div>
          <div style="
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #374151, #1f2937);
            padding: 12px 16px;
            border-radius: 16px;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transition: transform 0.2s ease;
          " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <span style="color: #10b981; font-size: 20px;">‚è∞</span> 
            Entrega: ${dueDateStr}
          </div>
          <div style="
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #374151, #1f2937);
            padding: 12px 16px;
            border-radius: 16px;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transition: transform 0.2s ease;
          " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <span style="color: #3b82f6; font-size: 20px;">üìù</span> 
            Registrado: ${createdAtStr}
          </div>
          ${isPending ? `<div style="
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, ${borderColor}, ${borderColor}aa);
            color: white;
            padding: 12px 16px;
            border-radius: 16px;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transition: transform 0.2s ease;
          " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <span style="font-size: 20px;">‚ö†Ô∏è</span>
            D√≠as afuera: ${days}
          </div>` : ""}
        </div>

        <!-- Botones con animaciones mejoradas -->
        <div style="display: flex; flex-wrap: wrap; gap: 14px;">
          <button class="small" style="
            flex: 1;
            min-width: 130px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 14px;
            padding: 12px 16px;
            font-size: 15px;
            font-weight: 700;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            cursor: pointer;
          " 
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.4)'" 
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)'"
          data-action="edit" data-id="${i.id}" data-type="${isPending ? "pending" : "loans"}">‚úèÔ∏è Editar</button>
          ${
            isPending
              ? `<button class="small" style="
                  flex: 1;
                  min-width: 130px;
                  background: linear-gradient(135deg, #ef4444, #dc2626);
                  color: white;
                  border: none;
                  border-radius: 14px;
                  padding: 12px 16px;
                  font-size: 15px;
                  font-weight: 700;
                  box-shadow: 0 6px 12px rgba(0,0,0,0.3);
                  transition: all 0.3s ease;
                  cursor: pointer;
                " 
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.4)'" 
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)'"
                data-action="deletePending" data-id="${i.id}">üóëÔ∏è Borrar</button>
                 <button class="small" style="
                  flex: 1;
                  min-width: 130px;
                  background: linear-gradient(135deg, #22c55e, #16a34a);
                  color: white;
                  border: none;
                  border-radius: 14px;
                  padding: 12px 16px;
                  font-size: 15px;
                  font-weight: 700;
                  box-shadow: 0 6px 12px rgba(0,0,0,0.3);
                  transition: all 0.3s ease;
                  cursor: pointer;
                " 
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.4)'" 
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)'"
                data-action="returnPending" data-id="${i.id}">üîÑ Devolver</button>`
              : `<button class="small" style="
                  flex: 1;
                  min-width: 130px;
                  background: linear-gradient(135deg, #f59e0b, #d97706);
                  color: white;
                  border: none;
                  border-radius: 14px;
                  padding: 12px 16px;
                  font-size: 15px;
                  font-weight: 700;
                  box-shadow: 0 6px 12px rgba(0,0,0,0.3);
                  transition: all 0.3s ease;
                  cursor: pointer;
                " 
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.4)'" 
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)'"
                data-action="pending" data-id="${i.id}">‚è≥ Pendiente</button>
                 <button class="small" style="
                  flex: 1;
                  min-width: 130px;
                  background: linear-gradient(135deg, #ef4444, #dc2626);
                  color: white;
                  border: none;
                  border-radius: 14px;
                  padding: 12px 16px;
                  font-size: 15px;
                  font-weight: 700;
                  box-shadow: 0 6px 12px rgba(0,0,0,0.3);
                  transition: all 0.3s ease;
                  cursor: pointer;
                " 
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.4)'" 
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)'"
                data-action="delete" data-id="${i.id}">üóëÔ∏è Borrar</button>`
          }
        </div>

      </div>
    `;
  });

  details.innerHTML = html;

  // Animar el panel desliz√°ndose
  panel.style.transition = 'right 0.5s ease-out';
  panel.style.right = "0";

  // Animar elementos despu√©s de renderizar
  setTimeout(() => {
    const header = document.getElementById('header');
    const total = document.getElementById('total');
    const items = document.querySelectorAll('.loan-item');

    if (header) animateIn(header, 0);
    if (total) animateIn(total, 200);
    items.forEach((item, index) => animateIn(item, 400 + index * 100));
  }, 100);
}


document.getElementById("closePanel").onclick = () => {
  document.getElementById("sidePanel").style.right = "-500px";
};

async function startEdit(id) {
  const item =
    loans.find(x => x.id === id) ||
    pending.find(x => x.id === id);

  if (!item) return;

  Swal.fire({
    title: "Editar registro",
    html: `
      <input id="editPerson" class="swal2-input" placeholder="Persona" value="${item.person}">
      <input id="editTool" class="swal2-input" placeholder="Herramienta" value="${item.tool}">
      <input id="editQty" type="number" class="swal2-input" placeholder="Cantidad" value="${item.quantity}">
      <input id="editPriority" class="swal2-input" placeholder="Prioridad" value="${item.priority}">
      <input id="editDue" type="date" class="swal2-input" value="${item.dueDate ? item.dueDate.split('T')[0] : ""}">
    `,
    confirmButtonText: "Guardar",
    showCancelButton: true,
  }).then(async (res) => {
    if (!res.isConfirmed) return;

    const updated = {
      person: document.getElementById("editPerson").value.trim(),
      tool: document.getElementById("editTool").value.trim(),
      quantity: Number(document.getElementById("editQty").value),
      priority: document.getElementById("editPriority").value.trim(),
      dueDate: document.getElementById("editDue").value || null,
    };

    await updateLoanFirestore(id, updated);

    Swal.fire("Actualizado", "Los cambios fueron guardados.", "success");

    loadData();
  });
}


async function updateLoanFirestore(id, data) {
  // Detecta si el registro est√° en loans o pending
  const isPending = pending.some(x => x.id === id);
  const collectionName = isPending ? "pending" : "loans";
  const docRef = doc(db, collectionName, id);

  // Actualiza en Firestore
  await updateDoc(docRef, data);

  // Actualiza array local
  const item = isPending ? pending.find(x => x.id === id) : loans.find(x => x.id === id);
  Object.assign(item, data);

  // Refresca detalles si el panel est√° abierto
  openDetails(item.person, isPending ? "pending" : "active");
}


/* ============================================================
   ======================== EVENTOS ============================
   ============================================================ */



document.addEventListener("click", (ev) => {

  /* ===============  PDF PENDIENTES  ================= */
  if (ev.target.closest("#downloadPendingPDF")) {
      console.log("PDF pendientes");
      generatePendingPDF();
      return; // <- opcional, pero limpio
  }

  /* ===============  PDF ACTIVOS HOY  ================= */
  if (ev.target.closest("#downloadActiveTodayPDF")) {
      console.log("PDF activos hoy");
      generateActiveTodayPDF();
      return;
  }


  const btn = ev.target.closest("[data-action]");
  if (!btn) return;

  const action = btn.dataset.action;
  const id = btn.dataset.id;
  const person = btn.dataset.person;

  /* ============================
     üóëÔ∏è BORRAR ACTIVO
     ============================ */
if (action === "delete") {
  const item = loans.find(l => l.id === id);
  if (!item) return;

  // Pedir al usuario la cantidad a eliminar
  let qtyToRemove = parseInt(prompt(`Cantidad actual: ${item.quantity}. ¬øCu√°ntas quieres eliminar?`, "1"), 10);
  if (!qtyToRemove || qtyToRemove <= 0) return;

  // Llamamos a removeQuantity que maneja Firestore y arrays locales
  removeQuantity(id, "loans", qtyToRemove)
  
    .then(() => {
      const card = document.querySelector(`.loan-item[data-id="${id}"]`);
      if (!card) return;

      // Si la cantidad qued√≥ <= 0, la tarjeta ya se elimina en removeQuantity
      if (item.quantity > 0) {
        // Actualizamos cantidad visible en la tarjeta
        const qtyDivs = Array.from(card.querySelectorAll("div")).filter(d => d.textContent.includes("Cantidad:"));
        if (qtyDivs.length > 0) {
          qtyDivs[0].innerHTML = `üì¶ Cantidad: ${item.quantity}`;
        }

        // Opcional: animaci√≥n breve para indicar actualizaci√≥n
        card.style.transition = "transform 0.2s";
        card.style.transform = "scale(1.03)";
        setTimeout(() => card.style.transform = "scale(1)", 200);
      }
    })
    .catch(err => console.error("Error eliminando cantidad:", err));
    
}

  if (action === "details-person") {
    const type = btn.dataset.type || "active";
    openDetails(person, type);
  }

  /* ============================
     üîÑ MARCAR DEVUELTO
     ============================ */
  if (action === "toggle") {
    toggleReturned(id);
  }


    /* =========================
    ‚úèÔ∏è EDITAR REGISTRO
    ========================= */
    if (action === "edit") {
        const item =
            loans.find(x => x.id === id) ||
            pending.find(x => x.id === id);
        if (!item) return;

        const isPending = pending.some(x => x.id === id);

        const newTool = prompt("Herramienta:", item.tool) || item.tool;
        const newQty = parseInt(prompt("Cantidad:", item.quantity), 10) || item.quantity;
        const newPriority = prompt("Prioridad (alta/normal/baja):", item.priority) || item.priority;
        const newDueDate = prompt("Fecha de entrega (YYYY-MM-DD):", item.dueDate || "") || item.dueDate;

        const docRef = doc(db, isPending ? "pending" : "loans", id);

        updateDoc(docRef, {
            tool: newTool,
            quantity: newQty,
            priority: newPriority,
            dueDate: newDueDate
        }).then(() => {
            // Actualizar array local
            item.tool = newTool;
            item.quantity = newQty;
            item.priority = newPriority;
            item.dueDate = newDueDate;

            // Si est√° abierto el panel, refrescar detalles
            openDetails(item.person, isPending ? "pending" : "active");
        }).catch(err => console.error("Error al actualizar:", err));
    }




  /* ============================
     ‚è≥ MOVER A PENDIENTES (1 item)
     ============================ */
  if (action === "pending") {
    if (confirm("¬øMover a pendientes?"))
      moveToPending(id);
  }

  /* ============================
     üóëÔ∏è BORRAR DE PENDIENTES (1 item)
     ============================ */
    if (action === "deletePending") {
    const item = pending.find(l => l.id === id);
    if (!item) return;

    let qtyToRemove = parseInt(prompt(`Cantidad actual: ${item.quantity}. ¬øCu√°ntas quieres eliminar?`, "1"), 10);
    if (!qtyToRemove || qtyToRemove <= 0) return;

    removeQuantity(id, "pending", qtyToRemove);
    removeItemFromDetails(id); // Actualiza el panel si borramos todo
    }



  /* ============================
     üîÑ REGRESAR DESDE PENDIENTES
     ============================ */
  if (action === "returnPending") {
    if (confirm("¬øVolver a activos?"))
      returnFromPending(id);
  }

  /* ============================
     ‚û°Ô∏è MOVER A PENDIENTES (por persona)
     ============================ */
  if (action === "pending-person") {
    loans
      .filter(x => x.person === person)
      .forEach(x => moveToPending(x.id));
  }

  /* ============================
     ‚Ü©Ô∏è MARCAR DEVUELTO (por persona)
     ============================ */
  if (action === "return-person") {
    loans
      .filter(x => x.person === person)
      .forEach(x => toggleReturned(x.id));
  }




});




$("loanForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const person = $("person").value.trim();
  const tool = $("tool").value.trim();
  const quantity = parseInt($("quantity").value,10);
  const dueDate = $("dueDate").value;
  const priority = $("priority").value;

  if (!person || !tool || !quantity || !dueDate) {
    alert("Completa todos los campos.");
    return;
  }

  await addLoan({ person, tool, quantity, dueDate, priority });

  $("loanForm").reset();
  $("quantity").value = 1;
  $("dueDate").value = todayISODate();
});

/* Init */
(function init(){
  $("dueDate").value = todayISODate();
})();

/* ============================================================
   =================== BUSCADOR EN PANEL ======================
   ============================================================ */

$("search").addEventListener("input", () => {
  const q = $("search").value.toLowerCase().trim();
  renderActiveList(q);
});

window.safe = safe;
window.diffDays = diffDays;
window.toValidDate = toValidDate;
window.generatePendingPDF = generatePendingPDF;
window.generateActiveTodayPDF = generateActiveTodayPDF;

</script>

<!-- ===================== PANEL LATERAL DE DETALLES ===================== -->
<div id="sidePanel" 
     style="
      position:fixed;
      top:0;
      right:-500px;
      width:420px;
      height:100%;
      background:rgba(20,25,35,0.95);
      backdrop-filter:blur(14px);
      box-shadow:-6px 0 25px rgba(0,0,0,0.5);
      padding:22px;
      z-index:999999;
      transition:all .35s ease;
      overflow-y:auto;
     ">
  
  <button id="closePanel"
      style="
        background:none;border:0;color:#aaa;font-size:20px;
        position:absolute;top:12px;right:18px;cursor:pointer;
        
      ">‚úñ</button>

  <h2 style="font-size:20px;margin-bottom:10px;color:#7dd3fc">Detalles del usuario</h2>
  
  <div id="detailsContent" style="margin-top:20px;font-size:15px;color:#c8d3df"></div>

</div>


</body>
</html>
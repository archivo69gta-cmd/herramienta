<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema Intuitivo de Pr√©stamo de Herramientas</title>
    <style>
    :root{
    --bg:#0b101a;
    --card:#0f1624;
    --muted:#9ba6b2;
    --accent:#7dd3fc;
    --accent-dark:#3bb0da;
    --danger:#ff6b6b;
    --success:#6ee7b7;
    --glass:rgba(255,255,255,0.05);
    --glass-2:rgba(255,255,255,0.03);
    }

    /* Reset */
    *{box-sizing:border-box; margin:0; padding:0}
    html,body{height:100%}

      @media (max-width: 768px) {
    .wrap { grid-template-columns: 1fr; gap: 10px; }
    .card { padding: 12px; }
    button { padding: 10px 12px; font-size: 13px; }
    }

    /* Background */
    body{
    font-family:Inter,ui-sans-serif,system-ui,"Segoe UI",Roboto;
    background: radial-gradient(circle at 20% 20%, #122338, #0b101a 70%);
    color:#eaf3fb;
    padding:32px;
    -webkit-font-smoothing:antialiased;
    animation:fadeIn .5s ease;
    }

    /* Layout */
    .wrap{
    max-width:1150px;
    margin:0 auto;
    display:grid;
    grid-template-columns:1fr 360px;
    gap:20px;
    align-items:start;
    animation:rise .6s ease;
    }

    /* Header */
    header{
    grid-column:1/-1;
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
    }

    h1{
    font-size:22px;
    font-weight:800;
    background:linear-gradient(90deg,#7dd3fc,#38bdf8);
    -webkit-background-clip:text;
    color:transparent;
    letter-spacing:-0.5px;
    animation:glowTitle 2s infinite alternate;
    }

    p.lead{
    color:var(--muted);
    font-size:14px;
    margin-top:4px;
    }

    /* Cards */
    .card{
    background:var(--glass-2);
    backdrop-filter:blur(12px);
    border-radius:16px;
    padding:18px;
    border:1px solid rgba(255,255,255,0.06);
    box-shadow:0 8px 25px rgba(0,0,0,0.5);
    animation:slideUp .45s ease;
    transition:transform .2s ease, box-shadow .2s ease;
    }
    .card:hover{
    transform:translateY(-3px);
    box-shadow:0 10px 30px rgba(0,0,0,0.55);
    }

    /* Forms */
    form .row{display:flex;gap:10px;margin-bottom:10px}

    label{
    font-size:12px;
    font-weight:600;
    color:var(--muted);
    margin-bottom:5px;
    }

    input,select,textarea{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.08);
    background:rgba(255,255,255,0.02);
    color:#eaf3fb;
    transition:border .15s, box-shadow .15s;
    }

    input:focus,select:focus,textarea:focus{
    border:1px solid var(--accent);
    box-shadow:0 0 0 3px rgba(125,211,252,0.25);
    outline:none;
    }

    /* Buttons */
    button{
    padding:12px 14px;
    border-radius:10px;
    border:0;
    font-weight:700;
    cursor:pointer;
    font-size:14px;
    background:linear-gradient(90deg,var(--accent),var(--accent-dark));
    color:#05212d;
    box-shadow:0 4px 14px rgba(125,211,252,0.28);
    transition:.2s ease;
    }
    button:hover{
    transform:translateY(-2px);
    box-shadow:0 6px 20px rgba(125,211,252,0.33);
    }

    button.ghost{
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.1);
    color:var(--muted);
    }
    button.ghost:hover{
    background:rgba(255,255,255,0.08);
    border-color:rgba(255,255,255,0.18);
    }

    /* Lists */
    .list{
    margin-top:12px;
    max-height:70vh;
    overflow:auto;
    padding-right:6px;
    animation:fadeIn .4s ease;
    }

    /* Scrollbar */
    .list::-webkit-scrollbar{
    width:8px;
    }
    .list::-webkit-scrollbar-thumb{
    background:rgba(255,255,255,0.08);
    border-radius:4px;
    }
    .list::-webkit-scrollbar-thumb:hover{
    background:rgba(255,255,255,0.12);
    }

    /* Items */
    .item{
    display:flex;
    gap:14px;
    align-items:flex-start;
    padding:14px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.05);
    background:var(--glass);
    backdrop-filter:blur(8px);
    margin-bottom:10px;
    animation:itemIn .25s ease;
    transition:background .15s;
    }
    .item:hover{
    background:rgba(255,255,255,0.08);
    }

    .item .main{flex:1}

    .meta{
    font-size:13px;
    color:var(--muted);
    margin-top:6px;
    }

    /* Badges */
    .badge{
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(255,255,255,0.08);
    border:1px solid rgba(255,255,255,0.1);
    backdrop-filter:blur(10px);
    }

    .overdue .badge{
    background:rgba(120,0,0,0.25);
    border-color:#6d0c0c;
    color:#ffbdbd;
    }

    .pending-count{
    font-size:14px;
    color:var(--danger);
    font-weight:700;
    margin-left:8px;
    }

    /* Controls */
    .controls{
    display:flex;
    gap:8px;
    align-items:center;
    }

    .small{
    padding:6px 10px;
    font-size:12px;
    border-radius:8px;
    font-weight:600;
    }

    .returned{
    opacity:0.55;
    text-decoration:line-through;
    }

    /* Strike visual */
    .strike-visual{
    display:inline-block;
    padding:2px 7px;
    border-radius:6px;
    background:rgba(0,0,0,0.35);
    color:var(--muted);
    font-size:12px;
    }

    /* Footer */
    footer{
    grid-column:1/-1;
    margin-top:16px;
    color:var(--muted);
    font-size:13px;
    text-align:center;
    }

    /* Animations */
    @keyframes fadeIn{
    from{opacity:0}
    to{opacity:1}
    }
    @keyframes rise{
    from{opacity:0; transform:translateY(8px)}
    to{opacity:1; transform:none}
    }
    @keyframes slideUp{
    from{opacity:0; transform:translateY(10px)}
    to{opacity:1; transform:none}
    }
    @keyframes itemIn{
    from{opacity:0; transform:translateY(4px)}
    to{opacity:1; transform:none}
    }
    @keyframes glowTitle{
    from{text-shadow:0 0 6px rgba(125,211,252,0.4)}
    to{text-shadow:0 0 14px rgba(125,211,252,0.9)}
    }
    </style>

</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Sistema de Pr√©stamo de Herramientas</h1>
        <p class="lead">Registra, marca y tacha como si fuera papel. Todo sincronizado.</p>
      </div>
      <div style="text-align:right">
        <div class="badge">Inventario global ‚Ä¢ Firestore</div>
      </div>
    </header>

    <!-- FORM -->
    <section class="card">
      <h2 style="margin:0 0 8px 0;font-size:16px">Registrar pr√©stamo</h2>

      <form id="loanForm" autocomplete="off">

        <div class="row">
          <div style="flex:1">
            <label>Nombre del usuario</label>
            <input id="person" type="text" required />
          </div>

          <div style="width:180px; position:relative">
            <label>Herramienta</label>
            <input id="tool" type="text" required />
          </div>
        </div>

        <div class="row">
          <div style="width:120px">
            <label>Cant.</label>
            <input id="quantity" type="number" min="1" value="1" required />
          </div>

          <div style="flex:1">
            <label>Fecha de entrega</label>
            <input id="dueDate" type="date" required />
          </div>

          <div style="width:140px">
            <label>Prioridad</label>
            <select id="priority">
              <option value="normal">Normal</option>
              <option value="alta">Alta</option>
              <option value="baja">Baja</option>
            </select>
          </div>
        </div>

        <div class="row" style="align-items:center">
          <button type="submit">A√±adir pr√©stamo</button>
          <button type="button" id="clearAll" class="ghost">Borrar todo</button>
          <div style="flex:1"></div>
        </div>

      </form>

      <hr style="border:none;height:12px">

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Pr√©stamos activos</strong>
        <div>
          <button id="showAll" class="ghost small">Mostrar todos</button>
          <button id="showOverdue" class="ghost small">Solo atrasados</button>
          
        </div>
      </div>

      <div id="activeList" class="list" aria-live="polite"></div>
    </section>

    <!-- ASIDE -->
    <aside class="card">
      <h2 style="margin:0 0 8px 0;font-size:16px">Panel</h2>

      <div style="margin-bottom:10px">
        <label>Buscar</label>
        <input id="search" type="text" placeholder="Buscar por nombre o herramienta" />
      </div>

      <div style="display:flex;gap:8px;margin-bottom:10px">
        <div style="flex:1">
          <label>Pendientes guardados</label>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Pendientes / Guardados</strong>
        <div id="pendingCount" class="pending-count">0</div>
      </div>

      <div id="pendingList" class="list"></div>
    </aside>

    <footer class="card">
      En tiempo real!.
    </footer>
  </div>

<!-- üî• AUTOCOMPLETADO & FIREBASE -->
<script type="module">

/* ============================================================
   ===============  CARGAR tools.json  =========================
   ============================================================ */
let toolList = [];

async function loadTools() {
  try {
    const res = await fetch("tools.json");
    toolList = await res.json();
    setupToolAutocomplete();
  } catch (err) { console.error("Error cargando tools.json", err); }
}
loadTools();

/* ============ AUTOCOMPLETADO ============ */
function setupToolAutocomplete() {
  const input = document.getElementById("tool");

  const box = document.createElement("div");
  box.id = "tool-autocomplete";
  box.style.position = "absolute";
  box.style.background = "var(--card)";
  box.style.border = "1px solid rgba(255,255,255,0.1)";
  box.style.borderRadius = "8px";
  box.style.padding = "6px";
  box.style.maxHeight = "160px";
  box.style.overflowY = "auto";
  box.style.display = "none";
  box.style.zIndex = "9999";
  document.body.appendChild(box);

  input.addEventListener("input", () => {
    const q = input.value.toLowerCase();
    if (!q) { box.style.display="none"; return; }

    const filtered = toolList.filter(t => t.toLowerCase().includes(q));
    if (!filtered.length) { box.style.display="none"; return; }

    const rect = input.getBoundingClientRect();
    box.style.left = rect.left + window.scrollX + "px";
    box.style.top = rect.bottom + window.scrollY + "px";
    box.style.width = rect.width + "px";

    box.innerHTML = filtered.map(t=>`<div style="padding:6px;cursor:pointer">${t}</div>`).join("");

    box.querySelectorAll("div").forEach(div=>{
      div.onclick = () => {
        input.value = div.textContent;
        box.style.display="none";
      };
    });

    box.style.display="block";
  });

  document.addEventListener("click", e=>{
    if (e.target !== input && !e.target.closest("#tool-autocomplete"))
      box.style.display="none";
  });
}

/* ============================================================
   ==================  FIREBASE  ===============================
   ============================================================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, deleteDoc,
  doc, updateDoc, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCsPATOHurWixNzoSGWmRXNK_qxQJVcK6g",
    authDomain: "herramienta-2802d.firebaseapp.com",
    projectId: "herramienta-2802d",
    storageBucket: "herramienta-2802d.firebasestorage.app",
    messagingSenderId: "985971934426",
    appId: "1:985971934426:web:cb245e82e1ebe7399551e3"
  };



const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* üß™üíÄ ADDED: pending */
const pendingRef = collection(db, "pending");
/* üß™üíÄ END */

const loansRef = collection(db, "loans");
const historyRef = collection(db, "history");

/* ============================================================
   ==================  UTILIDADES  =============================
   ============================================================ */

const $ = (id) => document.getElementById(id);

const todayISODate = () => {
  const d = new Date();
  const tzOffset = d.getTimezoneOffset() * 60000;
  return new Date(d - tzOffset).toISOString().slice(0,10);
};

const escapeHtml = s =>
  String(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* ============================================================
   =====================  ESTADO  ==============================
   ============================================================ */
let loans = [];
let pending = []; /* üß™üíÄ ADDED */

/* Listener: LOANS */
onSnapshot(loansRef, (snap) => {
  loans = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderAll();
});

/* Listener: PENDING ‚Äî üß™üíÄ ADDED */
onSnapshot(pendingRef, (snap) => {
  pending = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderPendingList();
});

/* ============================================================
   =========================== CRUD ============================
   ============================================================ */

async function addLoan({person, tool, quantity, dueDate, priority}) {
  await addDoc(loansRef, {
    person, tool, quantity, dueDate, priority,
    returned:false,
    createdAt: serverTimestamp()
  });
}

async function removeLoan(id) {
  await deleteDoc(doc(db, "loans", id));
}

/* üß™üíÄ ADDED ‚Äî mover a pendientes */
/* ==================== MOVE TO PENDING ==================== */
async function moveToPending(id) {
  const l = loans.find(x => x.id === id);
  if (!l) return;

  await addDoc(pendingRef, {
    person: l.person,
    tool: l.tool,
    quantity: l.quantity,
    dueDate: l.dueDate,
    priority: l.priority,
    createdAt: l.createdAt || new Date(),
    movedAt: serverTimestamp() // <-- Timestamp real
  });

  await deleteDoc(doc(db, "loans", id));
}



/* üß™üíÄ END */

async function toggleReturned(id) {
  const l = loans.find(x => x.id === id);
  if (!l) return;

  if (!l.returned) {
    await addDoc(historyRef, {
      person: l.person,
      tool: l.tool,
      quantity: l.quantity,
      dueDate: l.dueDate,
      priority: l.priority,
      createdAt: l.createdAt || null,
      returnedAt: new Date().toISOString()
    });

    await deleteDoc(doc(db, "loans", id));
    return;
  }

  await updateDoc(doc(db, "loans", id), { returned: false });
}

/* ============================================================
   =============  VOLVER DE PENDIENTES A ACTIVOS  =============
   ============================================================ */

/* ==================== RETURN FROM PENDING ==================== */
async function returnFromPending(id) {
  const item = pending.find(x => x.id === id);
  if (!item) return;

  // Agregar a loans
  await addDoc(loansRef, {
    person: item.person,
    tool: item.tool,
    quantity: item.quantity,
    dueDate: item.dueDate,
    priority: item.priority,
    createdAt: item.createdAt
      ? (typeof item.createdAt.toDate === "function" ? item.createdAt.toDate() : new Date(item.createdAt))
      : new Date(),
    returned: false
  });

  // Borrar del pending
  await deleteDoc(doc(db, "pending", id));
}

function removeItemFromDetails(id) {
  const details = $("detailsContent");
  const itemEl = details.querySelector(`[data-id="${id}"]`);
  if (itemEl) {
    itemEl.remove();
  }

  // Actualiza el contador de registros en el panel
  const counterEl = details.querySelector("div[style*='opacity:.7']");
  if (counterEl) {
    const current = parseInt(counterEl.textContent.match(/\d+/)[0], 10);
    counterEl.textContent = `Total de registros: ${current - 1}`;
  }
}



/* ============================================================
   ======================== RENDER ==============================
   ============================================================ */

function renderAll() {
  renderActiveList();
  renderPendingList();
}

function closeDetails() {
  $("sidePanel").style.right = "-500px";
}

function renderActiveList(query = "") {
  const container = $("activeList");
  container.innerHTML = "";

  let data = loans;

  if (query) {
    data = loans.filter(l =>
      l.person.toLowerCase().includes(query) ||
      l.tool.toLowerCase().includes(query)
    );
  }

  // Agrupar por persona
  const groups = {};
  for(const l of data){
    if(!groups[l.person]) groups[l.person] = [];
    groups[l.person].push(l);
  }

  // Orden por prioridad dentro de cada grupo
  const order = { alta:1, normal:2, baja:3 };

  for(const person in groups){
    const items = groups[person].sort((a,b)=>order[a.priority]-order[b.priority]);

    const block = document.createElement("div");
    block.className = "item";

    block.innerHTML = `
      <div class="main">
        <strong style="font-size:16px">${person}</strong>
        <div class="meta">${items.length} registros</div>
      </div>

      <div class="controls">
        <button class="small ghost" data-action="details-person" data-person="${person}">
          Detalles
        </button>
      </div>
    `;

    container.appendChild(block);
  }
}



/* üß™üíÄ NEW REAL pending list ‚Äî basado en colecci√≥n pending */
/* ============================================================
   ============  PENDIENTES (COLORES POR D√çAS)  ===============
   ============================================================ */

/* ======================= RENDER PENDING LIST ======================= */
function renderPendingList() {
  const container = $("pendingList");
  container.innerHTML = "";

  $("pendingCount").textContent = pending.length;

  if (!pending.length) {
    container.innerHTML = `<div style="color:var(--muted);padding:12px">
      No hay pendientes guardados.
    </div>`;
    return;
  }

  const groups = {};
  pending.forEach(l => {
    if (!groups[l.person]) groups[l.person] = [];
    groups[l.person].push(l);
  });

  const order = { alta: 1, normal: 2, baja: 3 };

  const colorByDays = (days) => {
    if (days < 10) return "#4ade80";
    if (days < 20) return "#facc15";
    return "#f87171";
  };

  const diffDays = (date) => {
    const now = new Date();
    return Math.floor((now - date) / (1000 * 60 * 60 * 24));
  };

  for (const person in groups) {
    const items = groups[person].sort((a,b) => order[a.priority] - order[b.priority]);
    const total = items.length;

    // Tomamos la fecha m√°s reciente correctamente
    const latest = items.slice().sort((a,b)=>{
      const dateA = a.movedAt ? (typeof a.movedAt.toDate === "function" ? a.movedAt.toDate() : new Date(a.movedAt)) 
                               : (a.createdAt ? (typeof a.createdAt.toDate === "function" ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date());
      const dateB = b.movedAt ? (typeof b.movedAt.toDate === "function" ? b.movedAt.toDate() : new Date(b.movedAt)) 
                               : (b.createdAt ? (typeof b.createdAt.toDate === "function" ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date());
      return dateB - dateA; // descendente, m√°s reciente primero
    })[0];

    const baseDate = new Date(latest.dueDate);  // Asume que dueDate es una cadena ISO (YYYY-MM-DD)
    const days = diffDays(baseDate);

    const color = colorByDays(days);

    const block = document.createElement("div");
    block.className = "item";
    block.style.borderLeft = `6px solid ${color}`;

    block.innerHTML = `
      <div class="main">
        <strong style="font-size:16px">${person}</strong>
        <div class="meta">${total} registros ‚Ä¢ ${days} d√≠as fuera</div>
      </div>
      <div class="controls">
        <button class="small ghost" data-action="details-person" data-person="${person}" data-type="pending">
          Detalles
        </button>
      </div>
    `;

    container.appendChild(block);
  }
}



/* üß™üíÄ END */



/* ============================================================
   ============   PANEL LATERAL DE DETALLES   ==================
   ============================================================ */

/* ======================= OPEN DETAILS ======================= */
function openDetails(personName, type = "active") {
  const panel = $("sidePanel");
  const details = $("detailsContent");

  const listToShow = type === "pending" ? pending : loans;
  const items = listToShow.filter(x => x.person === personName);

  const diffDays = (date) => {
    const now = new Date();
    return Math.floor((now - date) / (1000 * 60 * 60 * 24));
  };

  const colorByDays = (days) => {
    if (days < 10) return "#4ade80";
    if (days < 20) return "#facc15";
    return "#f87171";
  };

  let html = `
    <div style="margin-bottom:8px;font-size:18px;font-weight:700">
      ${personName}
    </div>
    <div style="opacity:.7;margin-bottom:20px">
      Total de registros: ${items.length}
    </div>
  `;

  for (const i of items) {
    const isPending = type === "pending";
    let days = 0;
    let borderColor = "transparent";

    if (isPending) {
      // Usar dueDate para calcular d√≠as (consistente con la lista principal)
      const baseDate = new Date(i.dueDate);  // Asume que dueDate es una cadena ISO (YYYY-MM-DD)
      days = diffDays(baseDate);
      borderColor = colorByDays(days);
    }

    html += `
      <div class="loan-item" data-id="${i.id}" style="
        padding:12px 14px;
        margin-bottom:10px;
        border-radius:12px;
        background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,255,255,0.1);
        ${isPending ? `border-left:6px solid ${borderColor};` : ""}
        position:relative;
      ">
        <div style="font-size:16px;font-weight:600;color:#7dd3fc">
          ${i.tool || "‚Äî"}
        </div>

        <div style="opacity:.8;margin-top:6px">Cantidad: ${i.quantity || 0}</div>
        <div style="opacity:.8">Prioridad: ${i.priority || "normal"}</div>
        <div style="opacity:.8">Fecha entrega: ${i.dueDate || "‚Äî"}</div>
        ${isPending ? `<div style="opacity:.8">D√≠as afuera: ${days}</div>` : ""}

        <div style="
          position:absolute;
          right:10px;
          top:10px;
          display:flex;
          gap:10px;
        ">
          ${
            isPending
              ? `
                <button class="small" style="background:#ef4444;border:none" 
                  data-action="deletePending" data-id="${i.id}">üóëÔ∏è</button>
                <button class="small" style="background:#4ade80;border:none" 
                  data-action="returnPending" data-id="${i.id}">üîÑ</button>
              `
              : `
                <button class="small" style="background:#facc15;border:none" 
                  data-action="pending" data-id="${i.id}">‚è≥</button>
                <button class="small" style="background:#ef4444;border:none" 
                  data-action="delete" data-id="${i.id}">üóëÔ∏è</button>
              `
          }
        </div>
      </div>
    `;
  }

  details.innerHTML = html;
  panel.style.right = "0";
}

document.getElementById("closePanel").onclick = () => {
  document.getElementById("sidePanel").style.right = "-500px";
};



/* ============================================================
   ======================== EVENTOS ============================
   ============================================================ */



document.addEventListener("click", (ev) => {
  const btn = ev.target.closest("[data-action]");
  if (!btn) return;

  const action = btn.dataset.action;
  const id = btn.dataset.id;
  const person = btn.dataset.person;

  /* ============================
     üóëÔ∏è BORRAR ACTIVO
     ============================ */
  if (action === "delete") {
    if (confirm("¬øSeguro que deseas borrar este registro?")) {
      removeLoan(id);
      removeItemFromDetails(id); // üîπ Tambi√©n para activos
    }
  }

  if (action === "details-person") {
    const type = btn.dataset.type || "active";
    openDetails(person, type);
  }

  /* ============================
     üîÑ MARCAR DEVUELTO
     ============================ */
  if (action === "toggle") {
    toggleReturned(id);
  }



  /* ============================
     ‚è≥ MOVER A PENDIENTES (1 item)
     ============================ */
  if (action === "pending") {
    if (confirm("¬øMover a pendientes?"))
      moveToPending(id);
  }

  /* ============================
     üóëÔ∏è BORRAR DE PENDIENTES (1 item)
     ============================ */
if (action === "deletePending") {
  if (confirm("¬øSeguro que deseas borrar este registro?")) {
    deleteDoc(doc(db, "pending", id));
    removeItemFromDetails(id); // üîπ Esto actualiza el panel instant√°neamente
  }
}


  /* ============================
     üîÑ REGRESAR DESDE PENDIENTES
     ============================ */
  if (action === "returnPending") {
    if (confirm("¬øVolver a activos?"))
      returnFromPending(id);
  }

  /* ============================
     ‚û°Ô∏è MOVER A PENDIENTES (por persona)
     ============================ */
  if (action === "pending-person") {
    loans
      .filter(x => x.person === person)
      .forEach(x => moveToPending(x.id));
  }

  /* ============================
     ‚Ü©Ô∏è MARCAR DEVUELTO (por persona)
     ============================ */
  if (action === "return-person") {
    loans
      .filter(x => x.person === person)
      .forEach(x => toggleReturned(x.id));
  }

});


$("loanForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const person = $("person").value.trim();
  const tool = $("tool").value.trim();
  const quantity = parseInt($("quantity").value,10);
  const dueDate = $("dueDate").value;
  const priority = $("priority").value;

  if (!person || !tool || !quantity || !dueDate) {
    alert("Completa todos los campos.");
    return;
  }

  await addLoan({ person, tool, quantity, dueDate, priority });

  $("loanForm").reset();
  $("quantity").value = 1;
  $("dueDate").value = todayISODate();
});

/* Init */
(function init(){
  $("dueDate").value = todayISODate();
})();

/* ============================================================
   =================== BUSCADOR EN PANEL ======================
   ============================================================ */

$("search").addEventListener("input", () => {
  const q = $("search").value.toLowerCase().trim();
  renderActiveList(q);
});

</script>

<!-- ===================== PANEL LATERAL DE DETALLES ===================== -->
<div id="sidePanel" 
     style="
      position:fixed;
      top:0;
      right:-500px;
      width:420px;
      height:100%;
      background:rgba(20,25,35,0.95);
      backdrop-filter:blur(14px);
      box-shadow:-6px 0 25px rgba(0,0,0,0.5);
      padding:22px;
      z-index:999999;
      transition:all .35s ease;
      overflow-y:auto;
     ">
  
  <button id="closePanel"
      style="
        background:none;border:0;color:#aaa;font-size:20px;
        position:absolute;top:12px;right:18px;cursor:pointer;
        
      ">‚úñ</button>

  <h2 style="font-size:20px;margin-bottom:10px;color:#7dd3fc">Detalles del usuario</h2>
  
  <div id="detailsContent" style="margin-top:20px;font-size:15px;color:#c8d3df"></div>

</div>


</body>
</html>
